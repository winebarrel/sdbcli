#!/usr/bin/env ruby
$LOAD_PATH << File.join(File.expand_path(File.dirname(__FILE__)), '..', 'lib')

require 'rubygems'
require 'sdbcli'

require 'optparse'
require 'readline'
require 'yaml'

access_key_id     = ENV['AWS_ACCESS_KEY_ID']
secret_access_key = ENV['AWS_SECRET_ACCESS_KEY']
sdb_endpoint      = ENV['SDB_ENDPOINT'] || 'sdb.amazonaws.com'

ARGV.options do |opt|
  opt.on('-k', '--access-key=ACCESS_KEY') {|v| access_key_id = v }
  opt.on('-s', '--secret-key=SECRET_KEY') {|v| secret_access_key = v }
  opt.on('-e', '--endpoint=ENDPOINT') {|v| sdb_endpoint = v }
  opt.parse!

  unless access_key_id and secret_access_key and sdb_endpoint
    puts opt.help
    exit 1
  end
end

$runner = SimpleDB::Runner.new(access_key_id, secret_access_key, sdb_endpoint)

def execute(query)
  out = $runner.execute(query)
  puts YAML.dump(out) if out
end

unless $stdin.tty?
  execute($stdin.read)
  exit 0
end

if sdb_endpoint =~ /sdb\.([^.]+)\.amazonaws\.com/
  region = $1
else
  region = 'us-east-1'
end

def help
  <<-EOS
SHOW domains
  displays a domain list

CREATE domain domain_name
  creates a domain

DROP DOMAIN domain_name
  deletes a domain

GET [output_list] FROM domain_name WHERE itemName = '...'
  gets the attribute of an item

INSERT INTO domain_name (itemName, attr1, ...) values ('name', 'val1', ...)
  creates an item

UPDATE domain_name set attr1 = 'val1', ... where itemName = '...'
  updates an item

DELETE [attr1, ...] FROM domain_name itemName = '...'
  deletes the attribute of an item or an item

SELECT output_list FROM domain_name [where expression] [sort_instructions] [limit limit]
  queries using the SELECT statement

    EOS
end

while buf = Readline.readline("#{region}> ", true)
  begin
    case buf.downcase
    when 'help'
      puts help
    when 'exit', 'quit'
      exit
    else
      execute(buf.sub(/;\Z/, ''))
    end
  rescue => e
    puts e.message.strip
  end
end
